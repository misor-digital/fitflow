name: Require Changeset

on:
  pull_request:
    branches: [main, main-test]
    types: [opened, labeled, unlabeled, synchronize]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Enforce changeset (unless skipped)
        run: |
          LABELS=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH")
          echo "PR labels: $LABELS"

          if echo "$LABELS" | grep -qx "^skip-release$"; then
            echo "üü° skip-release label present, skipping changeset check"
            exit 0
          fi

          FILES=$(ls .changeset/*.md | grep -v README.md || true)

          echo "Detected changeset files:"
          echo "$FILES"
          
          if [ -n "$FILES" ]; then
            echo "‚úÖ Changeset found"
            exit 0
          fi

          echo "‚ùå No changeset found."
          echo "Either add a changeset or apply the 'skip-release' label."
          exit 1
