name: Enforce PR title policy

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  pull-requests: write

jobs:
  enforce-title:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve prefix rules
        id: rules
        run: |
          HEAD="${{ github.event.pull_request.head.ref }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          TITLE="${{ github.event.pull_request.title }}"
          LABELS=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH")

          REQUIRED_PREFIX=""
          REQUIRE_ANY_PREFIX="false"

          # ----- HOTFIX override
          if echo "$LABELS" | grep -qx "hotfix"; then
            REQUIRED_PREFIX="[HOTFIX]"

          # ----- Known base branches
          elif [[ "$BASE" == "dev" ]]; then
            REQUIRED_PREFIX="[DEV]"

          elif [[ "$HEAD" == "dev" && "$BASE" == "stage" ]]; then
            REQUIRED_PREFIX="[STAGE]"

          elif [[ "$HEAD" == "stage" && "$BASE" == "main" ]]; then
            REQUIRED_PREFIX="[PROD]"

          # ----- Unknown base branch → must have *some* prefix
          else
            REQUIRE_ANY_PREFIX="true"
          fi

          echo "required_prefix=$REQUIRED_PREFIX" >> "$GITHUB_OUTPUT"
          echo "require_any_prefix=$REQUIRE_ANY_PREFIX" >> "$GITHUB_OUTPUT"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

      - name: Enforce & auto-fix title
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          REQUIRED="${{ steps.rules.outputs.required_prefix }}"
          REQUIRE_ANY="${{ steps.rules.outputs.require_any_prefix }}"
          TITLE="${{ steps.rules.outputs.title }}"
          NUMBER="${{ github.event.pull_request.number }}"

          # ----- Exact prefix required
          if [[ -n "$REQUIRED" ]]; then
            if [[ "$TITLE" == "$REQUIRED"* ]]; then
              echo "✅ PR title already correct"
              exit 0
            fi

            NEW_TITLE="$REQUIRED $TITLE"
            echo "✏️ Updating PR title → $NEW_TITLE"
            gh pr edit "$NUMBER" --title "$NEW_TITLE"
            exit 0
          fi

          # ----- Any prefix required
          if [[ "$REQUIRE_ANY" == "true" ]]; then
            if [[ "$TITLE" =~ ^\[[A-Z0-9_-]+\]\  ]]; then
              echo "✅ Custom prefix already present"
              exit 0
            fi

            echo "❌ PR title must start with a prefix like [TEST], [SPIKE], [POC]"
            echo "Current title: $TITLE"
            exit 1
          fi

          exit 0
