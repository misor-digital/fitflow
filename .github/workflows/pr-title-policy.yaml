name: Enforce PR title policy

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  pull-requests: write

jobs:
  enforce-title:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve required prefix
        id: rules
        run: |
          HEAD="${{ github.event.pull_request.head.ref }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          TITLE="${{ github.event.pull_request.title }}"
          LABELS=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH")

          REQUIRED_PREFIX=""

          # ----- HOTFIX override
          if echo "$LABELS" | grep -qx "hotfix"; then
            REQUIRED_PREFIX="[HOTFIX]"
          else
            # ----- Promotion PR rules
            if [[ "$HEAD" == "dev" && "$BASE" == "stage" ]]; then
              REQUIRED_PREFIX="[STAGE]"
            elif [[ "$HEAD" == "stage" && "$BASE" == "main" ]]; then
              REQUIRED_PREFIX="[PROD]"
            elif [[ "$BASE" == "stage" || "$BASE" == "main" ]]; then
              echo "❌ PRs targeting '$BASE' must be promotion PRs (dev→stage or stage→main)"
              exit 1
            else
              # dev or feature PRs → no enforcement
              exit 0
            fi
          fi

          echo "required_prefix=$REQUIRED_PREFIX" >> "$GITHUB_OUTPUT"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

      - name: Enforce title prefix (fail if missing)
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          REQUIRED="${{ steps.rules.outputs.required_prefix }}"
          TITLE="${{ steps.rules.outputs.title }}"

          if [[ -z "$REQUIRED" ]]; then
            exit 0
          fi

          if [[ "$TITLE" == "$REQUIRED"* ]]; then
            echo "✅ PR title is valid"
            exit 0
          fi

          echo "❌ PR title must start with $REQUIRED"
          echo "Current title: $TITLE"
          exit 1
